
PROGRAM = httpServer_t

vpath %.h src
vpath %.c src

# if you want to buit in classProcessor.c, set CLSPRO = true else CLSPRO = 
#CLSPRO = true
CLSPRO = false

# if you want silent mode, set SILENT = -D_SILENT else SILENT =
SILENT = -D_SILENT


# gcc version 4.8 or older 
# CentOS7(gcc4.8) --> GCC_VR=  / raspi,CentOS5(gcc old) --> GCC_VR=-D_GCC_OLD
# GCC_VER="" or -D_GCC_OLD


# check distro
# return value = gcc -dumpmachine 
#	raspi -> arm-linux-gnueabihf
#	CentOS -> x86_64-redhat-linux
#       Ubuntu -> x86_64-linux-gnu
SYS := $(shell gcc -dumpmachine)
$(info SYS = ${SYS})

#ifneq (,$(findstring redhat,$(SYS)))
ifneq (,$(findstring x86_64,$(SYS)))
  RASPI=false
  #$(info CentOS complie!)
  $(info Ubuntu complie!)
else
  RASPI=true
  $(info Raspi complie!)
endif

# compile machine RASPI = true / false
#RASPI = false

ifeq ($(RASPI),true)
JAVAPL=/usr/lib/jvm/jdk-7-oracle-armhf
JAVALB=/jre/lib/arm/server
#JAVALB=/jre/lib/arm/client
GCC_VR=-D_GCC_OLD
else
JAVAPL=${JAVA_HOME}
JAVALB=/jre/lib/amd64/server
GCC_VR=
endif

ifeq ($(CLSPRO),true)
# classProcessor.c built in option setting
jFlag=
jObj = classProcessor.o
jHead = classProcessor.h
jInc=-I$(JAVAPL)/include -I$(JAVAPL)/include/linux
jLib=-L$(JAVAPL) -L$(JAVAPL)$(JAVALB)
jL=-ljvm
else
# classProcessor.c reject option setting
jFlag=-D_REJECT_CLASSPROCESSOR
jObj =
jHead =
jInc =
jLib=
jL=
endif

OBJS = httpServer_t.o requestDispatch.o contextProcessor.o serverConfig.o\
		com_lib.o cgiProcessor.o httpReader.o httpWriter.o constDef.o\
		checkAllowNetworks.o $(jObj)
CC = gcc
CFLAGS = -O3 -pthread -D_REENTRANT -D_POSIX_C_SOURCE $(jFlag) $(SILENT) $(GCC_VR)
LIB = $(jLib) 
LD = -lpthread $(jL)

INC = -I/usr/include/npt1 -I./src $(jInc)
HEAD = requestDispatch.h contextProcessor.h\
		serverConfig.h com_lib.h cgiProcessor.h\
		httpReader.h httpWriter.h constDef.h\
		tableDef.h checkAllowNetworks.h $(jHead)


all:$(PROGRAM)

$(PROGRAM): $(OBJS)
	$(CC) -Wall -O3 $(LIB) -o $(PROGRAM) $(OBJS) $(LD)
	strip $(PROGRAM)

httpServer_t.o : httpServer_t.c $(HEAD)
	$(CC) -c $(CFLAGS) $(INC) src/httpServer_t.c 

requestDispatch.o : requestDispatch.c $(HEAD)
	$(CC) -c $(CFLAGS) $(INC) src/requestDispatch.c 

contextProcessor.o : contextProcessor.c $(HEAD)
	$(CC) -c $(CFLAGS) $(INC) src/contextProcessor.c 

serverConfig.o : serverConfig.c $(HEAD)
	$(CC) -c $(CFLAGS) $(INC) src/serverConfig.c 

com_lib.o : com_lib.c $(HEAD)
	$(CC) -c $(CFLAGS) $(INC) src/com_lib.c 

cgiProcessor.o : cgiProcessor.c $(HEAD)
	$(CC) -c $(CFLAGS) $(INC) src/cgiProcessor.c 

#classProcessor.o : classProcessor.c $(HEAD)
#	$(CC) -c $(CFLAGS) $(INC) src/classProcessor.c 

httpReader.o : httpReader.c $(HEAD)
	$(CC) -c $(CFLAGS) $(INC) src/httpReader.c 

httpWriter.o : httpWriter.c $(HEAD)
	$(CC) -c $(CFLAGS) $(INC) src/httpWriter.c 

constDef.o : constDef.c $(HEAD)
	$(CC) -c $(CFLAGS) $(INC) src/constDef.c 

checkAllowNetworks.o : src/checkAllowNetworks.c $(HEAD)
	$(CC) -c $(CFLAGS) $(INC) src/checkAllowNetworks.c 


clean:
	rm  -f *.o


#javap="-I${JAVA_HOME}/include -I${JAVA_HOME}/include/linux -L${JAVA_HOME}/jre/lib -ljvm"

#all: src/httpServer_t.c src/requestDispatch.c src/requestDispatch.h src/httpReader.c src/httpReader.h src/contextProcessor.c src/contextProcessor.h src/serverConfig.c src/serverConfig.h src/com_lib.c src/com_lib.h src/cgiProcessor.c src/cgiProcessor.h src/classProcessor.c src/classProcessor.h src/httpReader.c src/httpReader.h src/httpWriter.c src/httpWriter.h src/constDef.c src/constDef.h src/tableDef.h src/checkAllowNetworks.c src/checkAllowNetworks.h
#	gcc -pthread -D_REENTRANT -D_POSIX_C_SOURCE -I/usr/include/npt1 -I./src -g -o httpServer_t src/com_lib.c src/httpServer_t.c src/requestDispatch.c src/httpReader.c src/httpWriter.c src/contextProcessor.c src/serverConfig.c src/cgiProcessor.c src/constDef.c src/checkAllowNetworks.c -lpthread
#	gcc -O2 -pthread -D_REENTRANT -D_POSIX_C_SOURCE -I/usr/include/npt1 -I./src $(javaInc) $(javaLib) -g -o httpServer_t src/com_lib.c src/httpServer_t.c src/requestDispatch.c src/httpReader.c src/httpWriter.c src/contextProcessor.c src/serverConfig.c src/cgiProcessor.c src/classProcessor.c src/constDef.c src/checkAllowNetworks.c -lpthread $(javaL)
#	gcc -O1 -pthread -D_REENTRANT -D_POSIX_C_SOURCE -I/usr/include/npt1 -I./src -g -o httpServer_t src/com_lib.c src/httpServer_t.c src/requestDispatch.c src/httpReader.c src/httpWriter.c src/contextProcessor.c src/serverConfig.c src/cgiProcessor.c src/constDef.c src/checkAllowNetworks.c -lpthread

#g++ -g -I/usr/lib/jvm/java-7-oracle/include/ -I/usr/lib/jvm/java-7-oracle/include/linux/ \
-L/usr/bin/java -L/usr/lib/jvm/java-7-oracle/jre/lib/amd64/server/ callJava.cpp -ljvm
